{% extends 'base.html' %}
{% block title %}CCTV Live Stream{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="text-center mb-4">
    <h1>CCTV Live Stream</h1>
  </div>
  <div id="video-container" class="shadow rounded mb-4">
    <video id="live-video" controls autoplay muted style="width:100%;background:#000;"></video>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const slug = urlParams.get("slug") || "live";
  const tsParam = urlParams.get("ts");
  const video = document.getElementById("live-video");

  fetch(`/get_hls_url/?slug=${slug}`)
    .then((r) => r.json())
    .then((data) => {
      if (!data.hls_url) return;
      const hlsUrl = data.hls_url;
      if (Hls.isSupported()) {
        const hls = new Hls({ lowLatencyMode: true, backBufferLength: 90 });
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        if (tsParam) {
          const tsMs = Date.parse(tsParam);
          hls.on(Hls.Events.LEVEL_LOADED, (_, d) => {
            const frags = d.details.fragments;
            if (!frags.length || !frags[0].programDateTime) return;
            const firstMs = frags[0].programDateTime.getTime();
            const offset = (tsMs - firstMs) / 1000;
            if (offset > 0 && offset < video.duration) video.currentTime = offset;
          });
        }
        hls.on(Hls.Events.ERROR, (_, d) => {
          if (!d.fatal) return;
          if (d.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
          else if (d.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
          else hls.destroy();
        });
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = hlsUrl;
        video.addEventListener("loadedmetadata", () => video.play());
      }
      if (tsParam) {
        const info = document.createElement("div");
        info.className = "alert alert-info mt-3";
        info.innerText = `Selected frame timestamp: ${new Date(tsParam).toLocaleString()}`;
        document.querySelector(".container").appendChild(info);
      }
    });
});
</script>
{% endblock %} 