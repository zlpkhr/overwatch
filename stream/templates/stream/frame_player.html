{% extends 'base.html' %}
{% block title %}Frame Player{% endblock %}
{% block content %}
<div class="container py-5 text-center">
  <h1 class="mb-4">Frame Player</h1>
  <div style="position:relative;display:inline-block;">
     <img id="frame-img" src="" alt="Frame" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#000;"/>
     <div id="overlay" style="position:absolute;top:0;left:0;pointer-events:none;"></div>
  </div>
  <div class="mt-3">
    <button id="btn-prev" class="btn btn-outline-primary me-2">Previous</button>
    <button id="btn-next" class="btn btn-outline-primary me-2">Next</button>
    <button id="btn-reset" class="btn btn-outline-secondary me-2">Reset</button>
    <button id="btn-toggle" class="btn btn-success">Play</button>
    <button id="btn-latest" class="btn btn-outline-primary me-2">Go to Latest</button>
  </div>
  <p class="mt-2" id="timestamp"></p>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function(){
  const urlParams=new URLSearchParams(window.location.search);
  const ts=urlParams.get('ts');
  if(!ts){alert('Missing ts param');return;}
  let nextAfter=ts;
  let playing=false;
  const imgEl=$('#frame-img');
  const overlay=$('#overlay');
  const tsLabel=$('#timestamp');
  const history=[];
  let pointer=-1;
  function fetchBatch(cb){
    $.getJSON('/frames/sequence/',{after:nextAfter,count:60}).done(d=>{
      const newFrames=d.results||[];
      if(newFrames.length){history.push(...newFrames);nextAfter=d.next_after||nextAfter;}
      if(typeof cb==='function')cb(newFrames);
    });
  }
  function drawBoxes(frameId){
    overlay.empty();
    $.getJSON(`/search/frame/${frameId}/detections/`,function(data){
      const dets=data.detections||[];
      const w=imgEl[0].naturalWidth;const h=imgEl[0].naturalHeight;
      const scale=imgEl.width()/w;
      dets.forEach(d=>{
        const [x1,y1,x2,y2]=d.bbox;
        const box=$('<div class="border border-danger position-absolute text-white small px-1"></div>').text(d.label);
        box.css({left:x1*w*scale,top:y1*h*scale,width:(x2-x1)*w*scale,height:(y2-y1)*h*scale,borderWidth:'2px',overflow:'hidden'});
        overlay.append(box);
      });
    });
  }
  function showFrame(frame){
    imgEl.attr('src',frame.image_url||'');
    tsLabel.text(new Date(frame.timestamp).toLocaleString());
    drawBoxes(frame.id);
  }
  function advance(){
    if(!playing)return;
    if(pointer+1<history.length){pointer++;showFrame(history[pointer]);return;}
    fetchBatch(()=>{if(history.length>pointer+1){pointer++;showFrame(history[pointer]);}});
  }
  setInterval(()=>advance(),1000);
  // initial fetch
  $.getJSON('/frames/sequence/',{after:ts,count:1,inc:1}).done(d=>{
    const first=d.results||[];
    if(first.length){history.push(first[0]);pointer=0;nextAfter=d.next_after||nextAfter;showFrame(history[0]);}
    fetchBatch();
  });
  function updateToggle(){const btn=$('#btn-toggle');btn.toggleClass('btn-danger',playing).toggleClass('btn-success',!playing).text(playing?'Pause':'Play');}
  $('#btn-toggle').on('click',()=>{playing=!playing;updateToggle();});
  $('#btn-next').on('click',()=>{playing=false;updateToggle();if(pointer+1<history.length){pointer++;showFrame(history[pointer]);}else{fetchBatch(()=>{if(pointer+1<history.length){pointer++;showFrame(history[pointer]);}});}});
  $('#btn-prev').on('click',()=>{playing=false;updateToggle();if(pointer>0){pointer--;showFrame(history[pointer]);}else{const firstTs=history[0]?.timestamp;if(!firstTs)return;$.getJSON('/frames/sequence/',{before:firstTs,count:60}).done(d=>{const older=d.results||[];if(older.length){history.unshift(...older);pointer+=older.length-1;showFrame(history[pointer]);}});}});
  $('#btn-reset').on('click',()=>{playing=false;updateToggle();pointer=0;showFrame(history[0]);});
  $('#btn-latest').on('click',()=>{$.getJSON('/frames/latest/',d=>{nextAfter=d.timestamp;history.push(d);pointer=history.length-1;showFrame(d);});});
});
</script>
{% endblock %} 